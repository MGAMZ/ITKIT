name: Auto Release

on:
  pull_request:
    types: [closed]
    branches:
      - 'v*'  # release branches like v1, v2, v3

jobs:
  determine-and-release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read

    steps:
      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.base.ref }}

      - name: Fetch all tags
        run: |
          git fetch --tags --force

      - name: Determine next version
        id: version
        env:
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Base ref: $BASE_REF"

          next_tag=""
          release_title=""

          if [[ "$BASE_REF" =~ ^v([0-9]+)$ ]]; then
            major="${BASH_REMATCH[1]}"
            echo "Release branch detected for major v$major"

            # Collect minor tags: strictly two-part tags vN.X
            mapfile -t minor_tags < <(git tag --list "v${major}.*" | grep -E "^v${major}\.[0-9]+$" | sort -V)
            if (( ${#minor_tags[@]} == 0 )); then
              next_tag="v${major}.1"
            else
              last="${minor_tags[-1]}"
              last_minor="${last##v${major}.}"
              next_minor=$((last_minor+1))
              next_tag="v${major}.${next_minor}"
            fi
            release_title="Release ${next_tag}"

          else
            echo "Not a release branch: $BASE_REF; skipping release."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Check if the computed tag already exists
          if git rev-parse -q --verify "refs/tags/${next_tag}" >/dev/null; then
            echo "Tag ${next_tag} already exists; skipping release."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "tag=${next_tag}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Computed next tag: ${next_tag}"
          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "tag=${next_tag}" >> "$GITHUB_OUTPUT"
          echo "title=${release_title}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        if: steps.version.outputs.skip != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.title }}
          target_commitish: ${{ github.event.pull_request.merge_commit_sha }}
          generate_release_notes: true
